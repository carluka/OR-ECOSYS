name: Test and Create PR for Main Branch

on:
  push:
    branches:
      - test

permissions:
  contents: write
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Potrebno za primerjavo med branchi

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "23.5.0"

      - name: Install dependencies
        run: |
          cd services/backend
          npm install

      - name: Run tests
        run: |
          cd services/backend
          npm test

      - name: Create Pull Request
        if: success() # Izvede se samo, Äe so vsi prejÅ¡nji koraki uspeÅ¡ni
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: main
          head: test
          title: "ğŸš€ Auto PR: Test â†’ Main"
          body: |
            ## ğŸ¯ Automated Pull Request

            This PR was automatically created after successful tests on the `test` branch.

            ### âœ… Tests Status
            - All backend tests passed successfully
            - Ready for review and merge to main

            ### ğŸ“‹ Changes
            - Latest changes from test branch
            - All tests are passing âœ…

            ### ğŸ” Review Checklist
            - [ ] Code review completed
            - [ ] No breaking changes
            - [ ] Documentation updated (if needed)

            ---
            *This PR was created automatically by GitHub Actions*
          draft: false
          delete-branch: false

      - name: Comment on PR (if created)
        if: success()
        run: |
          echo "âœ… Pull request created successfully!"
          echo "ğŸ”— Check the Pull Requests tab to review and merge"
