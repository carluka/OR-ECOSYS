name: Test and Create PR for Main Branch

on:
  push:
    branches:
      - test

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "23.5.0"

      - name: Install dependencies
        run: |
          cd services/backend
          npm install

      - name: Run tests
        run: |
          cd services/backend
          npm test

      - name: Create Pull Request
        if: success()
        uses: repo-sync/pull-request@v2
        with:
          source_branch: "test"
          destination_branch: "main"
          github_token: ${{ secrets.GITHUB_TOKEN }}
          pr_title: "🚀 Auto PR: Test → Main"
          pr_body: |
            ## 🎯 Automated Pull Request

            This PR was automatically created after successful tests on the `test` branch.

            ### ✅ Tests Status
            - All backend tests passed successfully
            - Ready for review and merge to main

            ### 📋 Changes
            - Latest changes from test branch
            - All tests are passing ✅

            ### 🔍 Review Checklist
            - [ ] Code review completed
            - [ ] No breaking changes
            - [ ] Documentation updated (if needed)

            ---
            *This PR was created automatically by GitHub Actions*
          pr_draft: false
          pr_allow_empty: true
