name: Test and Create PR for Main Branch

on:
  push:
    branches:
      - test

permissions:
  contents: write
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Potrebno za primerjavo med branchi

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "23.5.0"

      - name: Install dependencies
        run: |
          cd services/backend
          npm install

      - name: Run tests
        run: |
          cd services/backend
          npm test

      - name: Check if PR already exists
        id: check-pr
        run: |
          PR_EXISTS=$(gh pr list --base main --head test --json number | jq length)
          echo "PR_EXISTS=$PR_EXISTS" >> $GITHUB_ENV
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Pull Request
        if: success() && env.PR_EXISTS == '0'
        run: |
          gh pr create \
            --base main \
            --head test \
            --title "ğŸš€ Auto PR: Test â†’ Main" \
            --body "## ğŸ¯ Automated Pull Request

            This PR was automatically created after successful tests on the \`test\` branch.
            
            ### âœ… Tests Status
            - All backend tests passed successfully
            - Ready for review and merge to main
            
            ### ğŸ“‹ Changes
            - Latest changes from test branch
            - All tests are passing âœ…
            
            ### ğŸ” Review Checklist
            - [ ] Code review completed
            - [ ] No breaking changes
            - [ ] Documentation updated (if needed)
            
            ---
            *This PR was created automatically by GitHub Actions*"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on existing PR
        if: success() && env.PR_EXISTS != '0'
        run: |
          PR_NUMBER=$(gh pr list --base main --head test --json number --jq '.[0].number')
          gh pr comment $PR_NUMBER --body "âœ… Tests passed on latest push to test branch!"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
