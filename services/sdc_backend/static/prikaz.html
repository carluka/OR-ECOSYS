<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Operacijska soba 1</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/uplot@1.6.24/dist/uPlot.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/uplot@1.6.24/dist/uPlot.iife.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      #status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
      }
      .connected {
        background-color: #d4edda;
        color: #155724;
      }
      .disconnected {
        background-color: #f8d7da;
        color: #721c24;
      }
      button {
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 10px;
      }
      button:hover {
        background-color: #0056b3;
      }
      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      #heart-display {
        display: flex;
        align-items: center;
        font-size: 2.5em;
        margin: 20px 0;
      }
      .heart {
        color: red;
        margin-right: 10px;
        animation: beat 1s infinite;
      }
      @keyframes beat {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.2);
        }
      }
      .chart-box {
        margin-top: 20px;
      }
      .uplot {
        max-width: 100%;
      }
    </style>
  </head>
  <body>
    <h1>SDC WebSocket Test</h1>

    <div id="status" class="disconnected">Status: Disconnected</div>
    <button id="connectBtn">Connect</button>
    <button id="disconnectBtn" disabled>Disconnect</button>

    <h2>Current Heart Rate</h2>
    <div id="heart-display">
      <span class="heart">❤️</span>
      <span id="current-hr">--</span> bpm
    </div>

    <div class="chart-box">
      <h2>Heart Rate Over Time</h2>
      <div id="hrChart"></div>
    </div>

    <h2>Current SPO₂</h2>
    <div style="font-size: 2em; margin: 20px 0">
      <span id="current-spo2">--</span> %
    </div>

    <div class="chart-box">
      <h2>SPO₂ Over Time</h2>
      <div id="spo2Chart"></div>
    </div>

    <div class="chart-box">
      <h2>ECG Waveform</h2>
      <div id="ecgChart"></div>
    </div>

    <script>
      let ws = null;
      const MAX_POINTS = 1500; // 3 seconds * 500Hz

      const statusDiv = document.getElementById("status");
      const connectBtn = document.getElementById("connectBtn");
      const disconnectBtn = document.getElementById("disconnectBtn");
      const currentHrSpan = document.getElementById("current-hr");
      const currentSpo2Span = document.getElementById("current-spo2");

      const hrData = [[], []];
      const spo2Data = [[], []];
      const ecgData = [[], []];

      const hrChart = new uPlot(
        {
          width: 800,
          height: 300,
          title: "Heart Rate (BPM)",
          scales: { x: { time: true }, y: { range: [50, 120] } },
          series: [{}, { label: "BPM", stroke: "red" }],
        },
        hrData,
        document.getElementById("hrChart")
      );

      const spo2Chart = new uPlot(
        {
          width: 800,
          height: 300,
          title: "SPO2 (%)",
          scales: { x: { time: true }, y: { range: [80, 100] } },
          series: [{}, { label: "SPO2", stroke: "blue" }],
        },
        spo2Data,
        document.getElementById("spo2Chart")
      );

      const ecgChart = new uPlot(
        {
          width: 800,
          height: 300,
          title: "Live ECG Waveform",
          scales: {
            x: { time: false, range: [0, 3] },
            y: { auto: true },
          },
          series: [{}, { label: "ECG", stroke: "green" }],
        },
        ecgData,
        document.getElementById("ecgChart")
      );

      function updateStatus(connected) {
        statusDiv.textContent = `Status: ${
          connected ? "Connected" : "Disconnected"
        }`;
        statusDiv.className = connected ? "connected" : "disconnected";
        connectBtn.disabled = connected;
        disconnectBtn.disabled = !connected;
      }

      function addData(chart, dataArray, timestamp, value) {
        dataArray[0].push(timestamp / 1000);
        dataArray[1].push(value);
        if (dataArray[0].length > 60) {
          dataArray[0].shift();
          dataArray[1].shift();
        }
        chart.setData(dataArray);
      }

      function handleMetric(data) {
        const { timestamp, metrics, device_id } = data;
        const ts = new Date(timestamp).getTime();

        for (const [metricName, value] of Object.entries(metrics)) {
          if (metricName === "ecgWaveform.ch0.ecg_module2") {
            const samples = JSON.parse(value); // array of floats
            const samplingRate = 500;
            const start =
              ecgData[0].length > 0 ? ecgData[0][ecgData[0].length - 1] : 0;

            for (let i = 0; i < samples.length; i++) {
              const time = start + 1 / samplingRate;
              ecgData[0].push(time);
              ecgData[1].push(samples[i]);
              if (ecgData[0].length > MAX_POINTS) {
                ecgData[0].shift();
                ecgData[1].shift();
              }
            }
            ecgChart.setData(ecgData);
          } else if (device_id === "numeric.ch0.vmd0") {
            currentHrSpan.textContent = value;
            addData(hrChart, hrData, ts, value);
          } else if (device_id === "numeric.ch1.vmd1") {
            currentSpo2Span.textContent = value;
            addData(spo2Chart, spo2Data, ts, value);
          } else {
            console.warn("Unknown metric:", metricName);
          }
        }
      }

      function connect() {
        if (ws) ws.close();
        ws = new WebSocket("ws://localhost:8000/ws/medical-device");

        ws.onopen = () => updateStatus(true);

        ws.onmessage = (e) => {
          try {
            const d = JSON.parse(e.data);
            if (d.metrics) handleMetric(d);
          } catch (err) {
            console.error("Invalid message:", err);
          }
        };

        ws.onclose = () => {
          updateStatus(false);
          ws = null;
        };
      }

      function disconnect() {
        if (ws) ws.close();
      }

      connectBtn.addEventListener("click", connect);
      disconnectBtn.addEventListener("click", disconnect);
    </script>
  </body>
</html>
